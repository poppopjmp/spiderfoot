# =============================================================================
# Nginx config for SpiderFoot React SPA
#
# - Serves the built React app from /usr/share/nginx/html
# - Proxies /api/* requests to the backend API server ($SF_API_URL)
# - Proxies /ws/* websocket connections to the backend ($SF_WS_URL)
# - SPA fallback: all non-file routes → index.html (client-side routing)
# - Security headers, gzip compression, cache control
#
# $SF_API_URL and $SF_WS_URL are injected at container startup via envsubst.
# =============================================================================

server {
    listen       80;
    server_name  _;

    root   /usr/share/nginx/html;
    index  index.html;

    # ---- DNS Resolver (Docker embedded DNS) ----
    # Needed so proxy_pass re-resolves hostnames after container restarts.
    resolver 127.0.0.11 valid=30s ipv6=off;
    resolver_timeout 5s;

    # ---- Gzip ----
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 256;
    gzip_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/xml
        image/svg+xml
        font/woff2;

    # ---- Security Headers ----
    add_header X-Frame-Options        "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff"    always;
    add_header X-XSS-Protection       "1; mode=block" always;
    add_header Referrer-Policy         "strict-origin-when-cross-origin" always;

    # ---- API Reverse Proxy ----
    location /api/ {
        set $api_upstream    ${SF_API_URL};
        proxy_pass           $api_upstream;
        proxy_http_version  1.1;
        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto $scheme;
        proxy_read_timeout  300s;
        proxy_send_timeout  300s;
        proxy_buffering     off;

        # CORS — allow the SPA origin
        add_header Access-Control-Allow-Origin  "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-API-Key" always;

        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin  "*";
            add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS";
            add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-API-Key";
            add_header Access-Control-Max-Age        86400;
            add_header Content-Length                 0;
            add_header Content-Type                  "text/plain; charset=utf-8";
            return 204;
        }
    }

    # ---- WebSocket Proxy ----
    location /ws/ {
        set $ws_upstream     ${SF_WS_URL};
        proxy_pass           $ws_upstream;
        proxy_http_version  1.1;
        proxy_set_header    Upgrade    $http_upgrade;
        proxy_set_header    Connection "upgrade";
        proxy_set_header    Host       $host;
        proxy_set_header    X-Real-IP  $remote_addr;
        proxy_read_timeout  86400s;
    }

    # ---- Static Assets (immutable hashed files) ----
    location /assets/ {
        expires    1y;
        add_header Cache-Control "public, immutable";
        try_files  $uri =404;
    }

    # ---- Favicon / manifest / robots ----
    location ~* \.(ico|svg|png|webmanifest|robots\.txt)$ {
        expires    7d;
        add_header Cache-Control "public";
        try_files  $uri =404;
    }

    # ---- Backend Health / Version / Metrics Proxy ----
    # These endpoints live at the API root, not under /api/
    # Prefix match so /health, /health/dashboard, /health/live, etc. all proxy
    location /health {
        set $api_upstream    ${SF_API_URL};
        proxy_pass           $api_upstream$request_uri;
        proxy_http_version  1.1;
        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_set_header    X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_read_timeout  10s;
    }

    location = /version {
        set $api_upstream    ${SF_API_URL};
        proxy_pass           $api_upstream/version;
        proxy_http_version  1.1;
        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_read_timeout  10s;
    }

    location = /metrics {
        set $api_upstream    ${SF_API_URL};
        proxy_pass           $api_upstream/metrics;
        proxy_http_version  1.1;
        proxy_set_header    Host              $host;
        proxy_set_header    X-Real-IP         $remote_addr;
        proxy_read_timeout  10s;
    }

    # ---- SPA Fallback ----
    # All other routes → index.html so React Router handles them
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ---- Nginx Health Check ----
    location = /healthz {
        access_log off;
        return 200 "ok\n";
        add_header Content-Type text/plain;
    }
}
