# =============================================================================
# Traefik Dynamic Configuration â€” Middlewares, TLS & Dashboard
# =============================================================================
# Shared middlewares referenced by Docker labels on each service.
# This file is hot-reloaded by Traefik (watch: true in static config).
# =============================================================================

# --- TLS certificates (self-signed for dev) ---
# Generate certs:  ./scripts/generate-traefik-certs.sh
# For production, use Let's Encrypt (see traefik.yml) and remove this section.
tls:
  certificates:
    - certFile: /certs/spiderfoot.crt
      keyFile: /certs/spiderfoot.key
  options:
    default:
      minVersion: "VersionTLS12"
      cipherSuites:
        - "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
        - "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
        - "TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256"
      sniStrict: false          # false for self-signed / localhost

http:
  # --- Traefik dashboard router (served via HTTPS, no separate port) ---
  routers:
    dashboard:
      rule: "PathPrefix(`/dashboard`) || PathPrefix(`/api/overview`)"
      entryPoints:
        - websecure
      tls: {}
      service: api@internal
      middlewares:
        - dashboard-auth
        - security-headers

  middlewares:
    # --- Dashboard basic auth (default: admin / spiderfoot) ---
    # Generate new hash:  htpasswd -nB admin
    dashboard-auth:
      basicAuth:
        users:
          - "admin:$2y$05$Rr7nUg6MlrAeeUmdOVQ06.2IS0.8zoApEM0EiFuuxvvEy26x8dC3e"
        realm: "SpiderFoot Dashboard"

    # --- Security headers ---
    security-headers:
      headers:
        frameDeny: true
        contentTypeNosniff: true
        browserXssFilter: true
        referrerPolicy: "strict-origin-when-cross-origin"
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true
        customResponseHeaders:
          X-Powered-By: ""
          Server: ""

    # --- Gzip compression ---
    gzip-compress:
      compress:
        excludedContentTypes:
          - "text/event-stream"

    # --- Rate limiting: general web ---
    rate-limit-web:
      rateLimit:
        average: 30
        burst: 60
        period: "1s"

    # --- Rate limiting: API ---
    rate-limit-api:
      rateLimit:
        average: 50
        burst: 100
        period: "1s"

    # --- Strip prefix helpers ---
    strip-grafana:
      stripPrefix:
        prefixes:
          - "/grafana"

    strip-jaeger:
      stripPrefix:
        prefixes:
          - "/jaeger"

    strip-prometheus:
      stripPrefix:
        prefixes:
          - "/prometheus"

    strip-litellm:
      stripPrefix:
        prefixes:
          - "/litellm"

    strip-minio:
      stripPrefix:
        prefixes:
          - "/minio"

    # --- Retry on transient failures ---
    retry-middleware:
      retry:
        attempts: 3
        initialInterval: "100ms"

    # --- Request body size limit (100 MB for doc uploads) ---
    body-limit:
      buffering:
        maxRequestBodyBytes: 104857600
        memRequestBodyBytes: 2097152
